<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>QSL Log Digital â€“ LW3DMV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Great+Maker&display=swap" rel="stylesheet">
<style>
body{background:#0e1b2b;color:#1ed6ff;font-family:Arial;margin:0;padding:20px}
input,button{padding:8px;margin:6px 0;width:100%}
button{background:#1ed6ff;color:#0e1b2b;border:none;cursor:pointer;font-weight:bold;font-family:'Great Maker', cursive}
.card{background:#12263f;padding:15px;margin-bottom:20px;border-radius:8px}
canvas{width:100%;max-width:950px;border:2px solid #1ed6ff;margin-top:10px}
.qslBox{margin-bottom:30px}
.hidden{display:none}
h2,h3{text-align:center;font-family:'Great Maker', cursive}
#perfil{background:#1a2f4d;padding:10px;border-radius:8px;margin-bottom:20px;display:flex;justify-content:space-between}
#soporte{text-align:center;margin-bottom:15px;font-family:'Great Maker', cursive}
</style>
</head>

<body>

<div id="soporte">ğŸ“§ Soporte: <a href="mailto:lw3dmv@gmail.com" style="color:#1ed6ff">lw3dmv@gmail.com</a></div>

<div id="loginBox" class="card">
<h2>ğŸ” Login / Registro</h2>
<input id="licLogin" placeholder="Licencia">
<input id="passLogin" type="password" placeholder="ContraseÃ±a">
<button onclick="login()">Entrar</button>
<button onclick="register()">Registrar</button>
</div>

<div id="app" class="hidden">

<div id="perfil">
<span>ğŸ‘¤ Usuario: <b id="userLic"></b></span>
<button onclick="logout()">ğŸšª Cerrar sesiÃ³n</button>
</div>

<h2>ğŸ“¡ QSL LOG DIGITAL â€“ LW3DMV</h2>
<div id="utc"></div>

<div class="card">
<h3>Imagen de fondo QSL</h3>
<input type="file" id="bg" accept="image/*">
</div>

<div class="card">
<h3>Actividad / Evento (opcional)</h3>
<input id="actividad" placeholder="Ej: DÃ­a del Radioaficionado">
</div>

<div class="card">
<h3>Contacto manual</h3>
<input id="op_call" placeholder="Tu licencia">
<input id="dx_call" placeholder="Licencia corresponsal">
<input type="date" id="m_date">
<input type="time" id="m_time">
<input id="m_band" placeholder="Banda">
<input id="m_mode" placeholder="Modo">
<input id="m_rst_s" placeholder="RST enviado">
<input id="m_rst_r" placeholder="RST recibido">
<button onclick="addManual()">Agregar contacto</button>
</div>

<div class="card">
<h3>Subir ADIF</h3>
<input type="file" id="adif" accept=".adi,.adif">
</div>

<div class="card">
<button onclick="downloadAll()">â¬‡ Descargar TODAS las QSL</button>
<button onclick="clearAll()">ğŸ—‘ Borrar todas</button>
</div>

<div class="card">
<h3>QSL Generadas</h3>
<div id="list"></div>
</div>

</div>

<script>
function horaSinSegundos(t){
  if(!t) return "";
  return t.substring(0,5);
}

function getUsers(){return JSON.parse(localStorage.getItem("qslUsers")||"{}");}
function register(){
  const l=licLogin.value,p=passLogin.value;
  if(!l||!p) return alert("Datos incompletos");
  const u=getUsers(); if(u[l]) return alert("Existe");
  u[l]=p; localStorage.setItem("qslUsers",JSON.stringify(u));
}
function login(){
  const u=getUsers();
  if(u[licLogin.value]!==passLogin.value) return alert("Error");
  localStorage.setItem("qslUser",licLogin.value); showApp();
}
function logout(){localStorage.removeItem("qslUser");location.reload();}
function showApp(){
  userLic.innerText=localStorage.getItem("qslUser");
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
}
if(localStorage.getItem("qslUser")) showApp();
setInterval(()=>utc.innerText="UTC: "+new Date().toUTCString(),1000);

let bgImg=null, qsls=[];
bg.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>bgImg=r.result;
  r.readAsDataURL(e.target.files[0]);
};

function addManual(){
  if(!bgImg) return alert("SubÃ­ la imagen QSL");
  if(!dx_call.value) return alert("Falta corresponsal");

  qsls.push({
    actividad: actividad.value.trim(),
    op: op_call.value || "",
    dx: dx_call.value,
    date: m_date.value,
    time: m_time.value,
    band: m_band.value,
    mode: m_mode.value,
    rst_s: m_rst_s.value,
    rst_r: m_rst_r.value
  });
  render();
}

adif.onchange=e=>{
  if(!bgImg) return alert("SubÃ­ la imagen QSL");
  const r=new FileReader();
  r.onload=()=>parseADIF(r.result);
  r.readAsText(e.target.files[0]);
};

function parseADIF(t){
  t.split(/<eor>/i).forEach(r=>{
    const g=f=>{
      const m=r.match(new RegExp(`<${f}:\\d+>([^<]+)`,'i'));
      return m?m[1].trim():"";
    };
    if(g("CALL") && g("STATION_CALLSIGN")){
      qsls.push({
        actividad: actividad.value.trim(),
        op: g("STATION_CALLSIGN"),
        dx: g("CALL"),
        date: g("QSO_DATE").replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3"),
        time: g("TIME_ON").replace(/(..)(..)/,"$1:$2"),
        band: g("BAND"),
        mode: g("MODE"),
        rst_s: g("RST_SENT"),
        rst_r: g("RST_RCVD")
      });
    }
  });
  render();
}

function clearAll(){qsls=[];render();}
function render(){list.innerHTML="";qsls.forEach(drawQSL);}

function fileName(q){
  const act=q.actividad ? q.actividad.toUpperCase().replace(/[^A-Z0-9]/g,"_")+"_":"";
  return act + q.dx.toUpperCase() + "_" + q.date + ".png";
}

function downloadAll(){qsls.forEach(q=>createAndDownload(q));}

function createAndDownload(q){
  const c=document.createElement("canvas");
  c.width=1900; c.height=1100;
  const x=c.getContext("2d");
  const img=new Image();
  img.onload=()=>{
    drawCanvas(x,c,q,img);
    const a=document.createElement("a");
    a.href=c.toDataURL("image/png");
    a.download=fileName(q);
    a.click();
  };
  img.src=bgImg;
}

function drawCanvas(x,c,q,img){
  x.drawImage(img,0,0,c.width,c.height);
  const bx=c.width-760, by=c.height-400;
  x.fillStyle="rgba(22,43,68,0.85)";
  x.fillRect(bx,by,760,360);
  x.strokeStyle="#1ed6ff";
  x.lineWidth=6;
  x.strokeRect(bx,by,760,360);

  x.fillStyle="#1ed6ff";
  x.font="bold 40px 'Great Maker', cursive";
  x.fillText("DE: "+q.op,bx+20,by+70);
  x.fillText("PARA: "+q.dx,bx+20,by+130);

  x.font="32px 'Great Maker', cursive";
  x.fillText("Fecha: "+q.date+" Hora: "+horaSinSegundos(q.time),bx+20,by+190);
  x.fillText("Banda: "+q.band+" Modo: "+q.mode,bx+20,by+245);
  x.fillText("RST S: "+q.rst_s+" RST R: "+q.rst_r,bx+20,by+300);
}

function drawQSL(q){
  const box=document.createElement("div");
  box.className="qslBox";
  const c=document.createElement("canvas");
  c.width=1900; c.height=1100;
  const x=c.getContext("2d");
  const img=new Image();
  img.onload=()=>drawCanvas(x,c,q,img);
  img.src=bgImg;

  const b=document.createElement("button");
  b.innerText="â¬‡ Descargar PNG";
  b.onclick=()=>createAndDownload(q);

  box.append(c,b);
  list.appendChild(box);
}
</script>

</body>
</html>
